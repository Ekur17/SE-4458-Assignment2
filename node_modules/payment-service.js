const amqp = require("amqplib");

const rabbitUrl = "amqp://localhost";
let channel;

// RabbitMQ bağlantısı
async function connectRabbitMQ() {
  const connection = await amqp.connect(rabbitUrl);
  channel = await connection.createChannel();

  // Kuyrukları oluştur
  await channel.assertQueue("notification_queue");
  await channel.assertQueue("compensation_queue");
  await channel.assertQueue("payment_queue");

  // payment_queue'yu dinle
  channel.consume("payment_queue", async (msg) => {
    const booking = JSON.parse(msg.content.toString());
    console.log("Processing payment for booking:", booking);

    const paymentSuccess = Math.random() > 0.3; // Ödeme başarı oranı %70

    if (paymentSuccess) {
      console.log("Payment successful. Sending to notification_queue...");
      await channel.sendToQueue(
        "notification_queue",
        Buffer.from(JSON.stringify(booking))
      );
    } else {
      console.log("Payment failed. Sending to compensation_queue...");
      await channel.sendToQueue(
        "compensation_queue",
        Buffer.from(JSON.stringify(booking))
      );
    }

    channel.ack(msg); // Mesajı işleme alındı olarak işaretle
  });
}

connectRabbitMQ();
